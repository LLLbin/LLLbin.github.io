---
layout:     post                    
title:      Linux - API        
subtitle:   Linuxå¸¸ç”¨APIğŸ›€
date:       2021-02-10            
author:     Lebin                     
header-img: img/post-bg-Vimrc.jpg
catalog: true                       
tags:                               
    - Linux
    - API
---

## Linuxç³»ç»Ÿä¸‹å¸¸ç”¨çš„API
#### (manæŸ¥çœ‹è¯¦ç»†æŒ‡ä»¤ç”¨æ³•, æˆ–è€…Vimå‘½ä»¤æ¨¡å¼ä¸‹2+Kä¹Ÿè¡Œ)

- open
- close
```
myTouch.c

#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>

int main(int argc, char *argv[])
{
    if(argc < 2)
    {
        printf("./a.out filename\n");
        return 1;
    }
    int fd = open(argv[1], O_RDONLY|O_CREAT, 0666); // åªè¯»ï¼Œåˆ›å»ºï¼Œæƒé™664ï¼ˆ0666ä¸~0002ï¼‰
    close(fd); // å…³é—­æ–‡ä»¶
    return 0;
}

```

- read
- write
```
myCat.c

#include <stdio.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <fcntl.h>

int main(int argc, char* argv[])
{
    if(argc != 2)
    {
        printf("./a.out filename\n");
        return -1;
    }
    int fd = open(argv[1], O_RDONLY); // åªè¯»
    // read file and print in stdout
    char buf[256];
    int ret = 0, wrt = 0;
    do{
        ret = read(fd, buf, sizeof(buf)); // è¯»å–ä¿¡æ¯
        wrt = write(STDOUT_FILENO, buf, ret); // æ ‡å‡†è¾“å‡ºï¼Œå†™å‡ºä¿¡æ¯
    }while(ret != 0); // å¾ªç¯è¯»å–ã€è¾“å‡º
    close(fd);
    return 0;
}

```


- fcntl
```
é˜»å¡æ¦‚å¿µï¼šreadå‡½æ•°åœ¨è¯»è®¾å¤‡ã€ç®¡é“ã€ç½‘ç»œçš„æ—¶å€™ç­‰å€™å¯¹æ–¹å‘æ¶ˆæ¯ã€‚
ï¼ˆè¾“å…¥è¾“å‡ºè®¾å¤‡å¯¹åº”/dev/ttyï¼‰

my_read_dev_tty.c

#include <stdio.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <fcntl.h>
#include <unistd.h>

int main(int argc, char* argv[])
{
    int fd = open("/dev/tty", O_RDWR);

    // éé˜»å¡æ§åˆ¶
    int flags = fcntl(fd, F_GETFL);
    flags |= O_NONBLOCK;    
    fcntl(fd, F_SETFL, flags);
 
    char buf[256] = {0};    
    int ret = 0; 
    while(1)     
    {
        ret = read(fd, buf, sizeof(buf));
        if(ret)  
        printf("buf is %s\n", buf);
        sleep(1);
    }
    close(fd);   
    return 0;
}
```

- lseek
```
myWriteRead.c

#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

int main(int argc, char *argv[])
{
    if(argc != 2)
    {
        printf("./a.out filename\n");
        return -1;
    }
    int fd = open(argv[1], O_RDWR|O_CREAT, 0666); // åªè¯»ï¼Œåˆ›å»ºï¼Œæƒé™664ï¼ˆ0666ä¸~0002ï¼‰
    char buf[256] = {0};
    int ret, wrt = write(fd, "helloworld\n", 11); // æ–‡ä»¶å†™å…¥â€œhelloworldâ€
    lseek(fd, 0, SEEK_SET); // å°†å…‰æ ‡ç§»å›æ–‡ä»¶å¼€å¤´ï¼ˆåŸæœ¬åœ¨helloworldçš„dåé¢ï¼‰
    do{
        ret = read(fd, buf, sizeof(buf));
        wrt = write(STDOUT_FILENO, buf, ret);
    }while(ret != 0); // å¾ªç¯è¯»å–ã€è¾“å‡º
    close(fd);

    return 0;
}
```

```
myFileSize.c

#include <stdio.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <fcntl.h>
#include <unistd.h>

int main(int argc, char* argv[])
{
    if(argc != 2)
    {
        printf("./a.out filename\n");
        return -1;
    }
    int fd = open(argv[1], O_RDONLY); \\ åªè¯»æ‰“å¼€æ–‡ä»¶
    int ret = lseek(fd, 0, SEEK_END); \\ ç§»åŠ¨å…‰æ ‡è‡³æ–‡ä»¶æœ«å°¾ï¼Œè¿”å›å¼€å¤´åˆ°å…‰æ ‡å¤„ï¼ˆæœ«å°¾ï¼‰çš„å­—èŠ‚æ•°
    printf("the file size is %d.\n", ret);
    close(fd);
    return 0;
}
```

```
myFileCreate.c

#include <stdio.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <fcntl.h>
#include <unistd.h>

int main(int argc, char* argv[])
{
    if(argc != 2)
    {
        printf("./a.out filename\n");
        return -1;
    }
    int fd = open(argv[1], O_WRONLY|O_CREAT, 0666);  // åªè¯»ï¼Œåˆ›å»ºï¼Œæƒé™664ï¼ˆ0666ä¸~0002ï¼‰
    int ret = lseek(fd, 1024, SEEK_END); // ç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾
    int wrt = write(fd, " ", 1); // å†™å…¥è‡³å°‘ä¸€ä¸ªå­—ç¬¦å³å¯æ‰©å»ºæ–‡ä»¶
    close(fd);

    return 0;
}
```

- stat
- lstat
```
myls.c

#include <stdio.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <grp.h>
#include <time.h>
#include <pwd.h>
#include <dirent.h>
#include <stdlib.h>

int fileLen;

void ls_file(char* filename)
{
    // æ–‡ä»¶çŠ¶æ€ç»“æ„
    struct stat statbuf;
    stat(filename , &statbuf);  // ç©¿é€è¯»å–æ–‡ä»¶çŠ¶æ€ 
    //lstat(argv[1], &statbuf); // éç©¿é€è¯»å–æ–‡ä»¶çŠ¶æ€

    // è§£ææ–‡ä»¶ç±»å‹
    char stmode[11] = {0};
    memset(stmode, '-', sizeof(stmode) - 1);
    if(S_ISREG(statbuf.st_mode))  stmode[0] = '-';
    if(S_ISCHR(statbuf.st_mode))  stmode[0] = 'c';
    if(S_ISDIR(statbuf.st_mode))  stmode[0] = 'd';
    if(S_ISBLK(statbuf.st_mode))  stmode[0] = 'b';
    if(S_ISLNK(statbuf.st_mode))  stmode[0] = 'l';
    if(S_ISFIFO(statbuf.st_mode)) stmode[0] = 'p';
    if(S_ISSOCK(statbuf.st_mode)) stmode[0] = 's';

    //è§£ææ–‡ä»¶æƒé™
    if(statbuf.st_mode & S_IRUSR) stmode[1] = 'r';
    if(statbuf.st_mode & S_IWUSR) stmode[2] = 'w';
    if(statbuf.st_mode & S_IXUSR) stmode[3] = 'x';
    
    if(statbuf.st_mode & S_IRGRP) stmode[4] = 'r';
    if(statbuf.st_mode & S_IWGRP) stmode[5] = 'w';
    if(statbuf.st_mode & S_IXGRP) stmode[6] = 'x';
    
    if(statbuf.st_mode & S_IROTH) stmode[7] = 'r';
    if(statbuf.st_mode & S_IWOTH) stmode[8] = 'w';
    if(statbuf.st_mode & S_IXOTH) stmode[9] = 'x';
    
    // è§£ææ–‡ä»¶ç”¨æˆ·åã€ç»„å
    char usename[20] = {0};
    char grpname[20] = {0};
    strcpy(usename, getpwuid(statbuf.st_uid)->pw_name);
    strcpy(grpname, getgrgid(statbuf.st_gid)->gr_name);

    // è§£ææ–‡ä»¶ä¿®æ”¹æ—¶é—´
    struct tm *filetm = localtime(&statbuf.st_atim.tv_sec);
    char timebuf[20] = {0};
    sprintf(timebuf, "%dæœˆ  %d %02d:%02d", filetm->tm_mon+1, filetm->tm_mday, filetm->tm_hour, filetm->tm_min);

    // è§£ææ–‡ä»¶åå­—
    char name[256] = {0};
    strcpy(name, filename+fileLen+1);

    // è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
    printf("%s %ld %s %s %5ld %s %s\n", stmode, statbuf.st_nlink, usename, grpname, statbuf.st_size, timebuf, name);
}

// é€’å½’æŸ¥æ‰¾æ–‡ä»¶
void ls_dir(char* dirname)
{
    DIR* dirp = opendir(dirname);
    if(dirp == NULL)
    {
        perror("dirname error");
        exit(-1);
    }
    struct dirent* dentp;
    while((dentp = readdir(dirp)) != NULL)
    {
        if(dentp->d_type == DT_DIR)
        {
            if(strcmp(".", dentp->d_name) == 0 || strcmp("..", dentp->d_name) == 0) continue;
            char newdirname[1024] = {0};
            sprintf(newdirname, "%s/%s", dirname, dentp->d_name);
            ls_dir(newdirname);
        }
        else 
        {
            char newdirname[1024] = {0};
            sprintf(newdirname, "%s/%s", dirname, dentp->d_name);
            ls_file(newdirname);
        }
    }
}


int main(int argc, char* argv[])
{
    char buf[256] = {0};
    getcwd(buf, sizeof(buf));    
    fileLen = strlen(buf);
    ls_dir(buf);    
    return 0;
}

```

- assess
```
æµ‹è¯•æ–‡ä»¶æƒé™å’Œæ˜¯å¦èƒ½æ‰“å¼€
```
- chmod
- chown
```
ä¿®æ”¹æ–‡ä»¶æƒé™å’Œç”¨æˆ·ã€ç»„åˆ«
```
- truncate 
```
æˆªæ–­æ–‡ä»¶ã€æ‰©å±•æ–‡ä»¶ã€‚ï¼ˆæ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼‰
```
- link
- symlink
```
ç”Ÿæˆç¡¬è¿æ¥ã€è½¯è¿æ¥ã€‚
```
- readlink
```
è¯»å–è½¯è¿æ¥å†…å®¹ï¼ˆç¡¬è¿æ¥ä¸è¡Œï¼‰ã€‚
```
- unlink
```
åˆ é™¤ï¼ˆè½¯ç¡¬ï¼‰è¿æ¥ã€‚
åˆ é™¤æ–‡ä»¶ã€‚è‹¥æ–‡ä»¶æ­£åœ¨è¢«åˆ«çš„è¿›ç¨‹å¼•ç”¨ï¼Œåˆ™åœ¨æ–‡ä»¶è¢«å…³é—­åå»¶æ—¶åˆ é™¤ã€‚
```
- rename
```
ä¿®æ”¹æ–‡ä»¶ã€ç›®å½•çš„åå­—ã€‚ï¼ˆæ–‡ä»¶ã€ç›®å½•å¿…é¡»å­˜åœ¨ï¼‰ã€‚
```
- getcwd
```
è·å–å½“å‰ç›®å½•è·¯å¾„ã€‚
```
- chdir
```
ä¿®æ”¹ç›®å½•ã€‚ï¼ˆè¿›ç¨‹ç‹¬æœ‰ï¼‰
```
- mkdir
```
æ–°å»ºç›®å½•ï¼ˆst_mode -> 0777 ç»™æ‰§è¡Œæƒé™ï¼‰ã€‚
```
- rmdir
```
åˆ é™¤ï¼ˆç©ºï¼‰ç›®å½•ã€‚
```
- opendir
- closedir
```
æ‰“å¼€ã€å…³é—­ç›®å½•ï¼ˆopenä¹‹åè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ç›®å½•æŒ‡é’ˆï¼‰
```
- readdir
```
è¯»å–ç›®å½•ï¼ˆè¿”å›ç›®å½•é¡¹å†…å®¹ï¼‰
```
```
myFileCnt.c

#include <stdio.h>
#include <sys/types.h>
#include <dirent.h>
#include <sys/stat.h>
#include <string.h>
#include <unistd.h>

int FileCnt(char* dirname)
{
    int fileCnt = 0;
    DIR *dirp = opendir(dirname);
    if(dirp == NULL)
    {
        perror("dirname error");
        return -1 ;
    }
    struct dirent* dentp;
    while((dentp = readdir(dirp)) != NULL)
    {
        if(dentp->d_type == DT_DIR)
        {
            // æ’é™¤.å’Œ..ä¸¤ä¸ªç›®å½•ã€‚
            if(strcmp(".", dentp->d_name) == 0 || strcmp("..", dentp->d_name) == 0)  continue;
            char newDirname[1024] = {0};
            sprintf(newDirname, "%s/%s", dirname, dentp->d_name);
            FileCnt(newDirname);
        }
        if(dentp->d_type == DT_REG) ++fileCnt;
    }
    closedir(dirp);
    return fileCnt;
}

int main(int argc, char* argv[])
{
    if(argc != 2)
    {
        printf("./a/out filename");
        return -1;
    }
    int fcnt = FileCnt(argv[1]);
    printf("total:%d\n", fcnt);
    return 0;
}

```
- rewinddir
```
å°†ç›®å½•æŒ‡é’ˆæ¢å¤è‡³åˆå§‹ä½ç½®
```
- telldir
- seekdir
```
telldir è¿”å›ç›®å½•æŒ‡é’ˆä½ç½®ï¼ˆé•¿æ•´å‹ï¼‰
seekdir è°ƒæ•´ç›®å½•æŒ‡é’ˆä½ç½®ï¼Œéœ€è¦å½“å‰ç›®å½•æŒ‡é’ˆä½ç½®ï¼ˆtelldirè·å¾—çš„é•¿æ•´å‹ï¼‰
```
- strerror
```
è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼ˆè¾“å…¥errror noï¼‰
```
- dup
- dup2
```
æ–‡ä»¶æè¿°ç¬¦å¤åˆ¶ï¼ˆæ–°å»ºä¸€ä¸ªæœ€å°çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰
æ–‡ä»¶æè¿°ç¬¦é‡å®šå‘ï¼ˆå…ˆå…³é—­æ—§çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå†æŒ‡å‘æ–°å¾—æ–‡ä»¶æè¿°ç¬¦ï¼‰
```